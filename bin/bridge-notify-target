#!/usr/bin/env node
// Write data to me on STDOUT like this:
//
// Endpoint: http://localhost:4005/events
// Name: hello this is a name
// Summary: some stuff bla bla
//
// And I will POST it as JSON to the Endpoint
const post = require('axios').post;
const fs = require('fs');
const format = require('util').format;
const logfile = __dirname+"/../logs/bridge-notify-target.log"
const lstr = fs.createWriteStream(logfile)
function log() { lstr.write(format.apply(this, arguments) + '\n') }
process.stdin.pipe(require('concat-stream')(data => {
  var out = {};
  var lines = data.toString().split('\n');
  lines.forEach((line) => {
    try {
      [_, key, val] = line.match(/^(\w+): (.+)/);
      out[key] = val;
    } catch (e) {
    }
  });
  var endpoint = out.Endpoint;
  delete out.Endpoint;
  post(endpoint, out).then(function() {
    console.info('successfully posted', out);
    log('successfully posted', out)
  }).catch(function(err) {
    console.error(err.stack);
    log(err.stack);
  });
}));
process.stdin.resume();
